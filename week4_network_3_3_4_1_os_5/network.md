# Chapter 3-3 ~ 4-3

## 키워드
- 라우터 : 패킷이 이동할 최적의 경로를 결정하기 위해 라우팅 테이블 이용
- 정적 라우팅 : 수동으로 채워진 라우팅 테이블 항목을 토대로 라우팅되는 방식
- 동적 라우팅 : 자동으로 채워진 라우팅 테이블 항목을 토대로 라우팅되는 방식
- 라우팅 프로토콜 : 라우팅의 범위에 따라 AS 내부에서 수행되는 IGP와 AS 외부에서 수행되는 EGP로 나뉨


- 전송 계층
  - 네트워크 계층과 응용 계층 사이에 위치 
  - 신뢰할 수 있는 연결형 통신이 가능한 프로토콜을 제공하기에 네트워크 계층의 한계 보완
  - 포트를 통해 응용 계층의 애플리케이션을 실별, 응용 계층과의 연결 다리 역할
- 신뢰할 수 없는 통신 : 패킷이 수신지까지 제대로 전송되었다는 보장을 하지 않는 통신 특성
- 비연결형 통신 : 송수신 호스트 간에 사전 연결 수립 작업을 거치지 않는 통신 특성
- 포트 : 응용 계층의 애플리케이션 프로세스를 식별하는 정보
  - 종류
    - 잘 알려진 포트
    - 등록된 포트
    - 동적 포트
- NAT : IP 주소를 변환하는 기술
- NAPT : 포트 기반의 NAT, NAT 테이블에 변환될 IP 주소 쌍과 더불어 포트 번호도 함께 기록


- NSS : TCP로 전송 가능한 최대 페이로드 크기
- TCP 세그먼트 : 송수신지 포트, 순서 번호, 확인 응답 번호, 제어 비트, 윈도우등의 필드가 존재
- 순서 번호 : TCP 세그먼트의 순서를 나타내기 위한 정보
- 확인 응답 번호 : 수신 호스트가 다음으로 받길 희망하는 순서 번호
- TCP는 쓰리 웨이 핸드셰이크로 연결 수립
- TCP는 CLOSED, ESTABLISGED, LISTEN 등 다양한 상태를 통해 현재 어떤 통신 과정에 있는지 나타내는 스테이트풀 프로토콜
- UDP : 비연결형 통신을 수행하는 신뢰할 수 없는 프로토콜로, 스테이트 리스 프로토콜의 일종
- UDP 데이터그램에는 송,수신지 포트, 길이, 체크섬 필드 존재


- RTT : 송신 호스트가 세그먼트를 전송한 뒤 그에 대한 답변을 받는 데까지 걸리는 시간
- ARQ : TCP의 재전송 기법, 문제가 발생하는 메시지를 재전송함으로써 신뢰성 확보
- 오류 제어를 위한 재전송 기법
  - Stop-and-Wait ARQ
  - Go-Back-N ARQ
  - Selective Repeat ARQ
- 흐름제어 : 수신자의 처리 속도를 고려하며 전송하는 방식, TCP는 이를 위해 슬라이딩 윈도우 사용
- 혼잡 제어 : 네트워크의 혼잡도를 판단하고 혼잡한 정도에 따라 전송량을 조절하는 방식
  - 느린 시작, 혼잡 회피, 빠른 회복등의 알고리즘이 사용될 수 있음






## 라우팅
- 라우팅 : 패킷이 이동할 최적의 경로를 설정한 뒤 해당 경로로 패킷을 이동시키는 것
- 라우터 : 네트워크 계층의 핵심 기능 담당
- 홉 : 라우팅 도중 패킷이 호스트와 라우터 간에, 혹은 라우터와 라우터 간에 이동하는 하나의 과정

### 라우팅 테이블
- 라우팅 테이블 : 특정 수신지까지 도달하기 위한 정보를 명시한 일종의 표와 같은 정보

- 포함된 정보 : 라우팅 방식에 따라, 호스트의 환경에 따라 달라질 수 있음
  - 핵심적인 정보 : 수신지 IP주소와 서브넷 마스크, 다음 홉등
    - 수신지 IP주소와 서브넷 마스크 : 최종적으로 패킷을 전달할 대상
    - 다음 홉 : 최종 수신지까지 가기 위해 다음으로 거쳐야 할 호스트의 IP주소나 인터페이스를 의미, 게이트웨이라고 명시되기도 함
    - 메트릭 : 해당 경로로 이동하는 데에 드는 비용

- 디폴트 라우트 : 라우팅 테이블에 없는 경로로 패킷을 전송할때, 기본적으로 패킷을 내보낼 경로를 설정하여 해당 경로로 패킷을 내보낼 수 있음, 이때 기본 경로


### 정적 라우팅과 동적 라우팅
- 정적 라우팅 : 사용자가 수동으로 직접 채워 넣은 라우팅 테이블의 항목을 토대로 라우팅되는 방식
- 동적 라우팅 : 자동으로 라우팅 테이블 항목을 만들고, 이를 이용하여 라우팅하는 방식
  - 라우팅 테이블 항목이 수시로 변할 수 있음


### AS(라우터들의 집단 네트워크)
- AS 경계 라우터(ASBR) : AS외부와 통신할 경우 AS경계에서 AS 내외로 통신을 주고받을 수 있는 특별한 라우터

### 라우팅 프로토콜
- 라우터끼리 자신들의 정보를 교환하며 패킷이 이동할 최적의 경로를 찾기 위한 프로토콜
- AS 내부에서 수행되느냐, 외부에서 수행되느냐에 따라 종류가 나뉨
- 내부 : IGP
  - 대표 : RIP, OSPF
  
- 외부 : EGP
  - 대표 : BGP

### IGP : RIP와 OSPF
- 최적의 경로를 선정하는 과정에서 거리백터와 링크상태중 사용되는것에 따라 구분
  - RIP : 거리벡터
    - 거리 벡터 : 거리를 기반으로 최적의 경로를 찾는 라우팅 프로토콜, 거리는 홉의 수를 의미
    
  - OSPF : 링크상태
    - OSPF는 링크 정보를 비롯한 현재 네트워크 상태를 그래프의 형태로 링크 상태 데이터베이스에 저장
      - 링크 상태 데이터베이스에는 라우터들의 연결 관계, 연결 비용등 그래프로 표현하기 위한 데이터 저장
      - 링크 상태 데이터베이스를 기반으로 지도처럼 그래프를 그린뒤 라우터가 최적의 경로를 선택
    - OSPF에서는 AS를 에어리어라는 단위로 나눔, 에어리어 경계에 있는 ABR이라는 라우터가 에어리어 간의 연결을 담당


### EGP: BGP
- AS 간의 통신에서 사용되는 대표적인 프로토콜
    - AS 간의 통신이 '가능한' 프로토콜
- 피어 : BGP 메시지를 주고받을 수있도록 연결된 BGP 라우터
- 피어링 : 다른 AS와의 BGP 연결을 유지하기 위해서 BGP 라우터끼리 연결되는 과정

- BGP 속성
  - AS-PATH
    - 메시지가 수신지에 이르는 과정에서 통과되는 AS들의 목록
  - NEXT_HOP
    - 다음으로 거칠 라우터의 IP 주소
  - LOCAL-PREF
    - LOCAL PREFERENCE의 약자 == 지역 선호도 
  
- 특징
  - BGP는 AS 간 라우팅을 할 때 거치게 될 '라우터'의 수가 아닌 'AS'의 수를 고려
  - RIP처럼 단순히 수신지에 이르는 거리가 아닌 메시지가 어디를 거쳐 이동하는지를 나타내는 경로를 고려






## 전송 계층
- 전송 계층 : 신뢰할 수 있는 통신과 연결형 통신을 가능하게 하여 IP의 한계를 극복하고, 포트 번호를 통해 응용 계층의 애플리케이션 프로세스들을 식별하는 역할

### IP의 한계를 보완하는 전송 계층
- 연결형 통신을 가능케 한다
  - 대표적인 프로토콜 : TCP
    - TCP : 두 호스트가 정보를 주고받기 전에 마치 가상의 회선을 설정하듯이 연결을 수립

- 신뢰성 있는 통신을 가능케 함
  - TCP는 패킷이 수신지까지 올바른 순서대로 확실히 전달 되는 것을 보장하기 위해 재전송을 통한 오류 제어, 흐름 제어, 혼잡 제어등 다양한 기능들을 제공
  - 성능을 위해 비 신뢰 통신, 비연결형 통신을 지원하는 프로토콜이 필요할 때가 있음 > UDP
    
### 응용 계층과 연결 다리, 포트
- 포트 : 패킷이 실행 중인 특정 애플리케이션까지 전달될때 패킷에 특정 애플리케이션을 식별할 수 있는 정보

- 포트의 분류
  - 전송계층에서는 포트 번호를 통해 특정 애플리케이션을 식별
  - 포트 번호는 16비트로 표현 
  - 사용 가능한 포트의 수 : 2^16(65536)개
  - 범위에 따라 분류
    - 잘 알려진 포트 : 0 ~ 1023
      - 시스템 포트라고도 부름, 범용적
      - 대표
        - 20, 21 : FTP
        - 22 : SSH
        - 23 : TELNET
        - 53 : DNS
        - 67, 68 : DHCP
        - 80 : HTTP
        - 443 : HTTPS

    - 등록된 포트 : 1024 ~ 49151
    
    - 동적 포트 : 49152 ~ 65535
      - 사설 포트, 임시 포트라고도 부름 
- IP 주소와 포트 번호에 대한 정보가 함께 주어지면 특정 호스트에서 실행 중인 특정 애플리케이션 프로세스를 식별할 수 있음

### 포트 기반 NAT
- NAT : IP 주소를 변환하는 기술
  - 주로 네트워크 내부의 사설 IP주소와 외부의 공인 IP 주소르 변환하는데 사용 > NAT 변환 테이블

- NAPT
  - 포트 기반의 NAT를 NAPT라고 함, 또는 APT
  - 포트를 활용해 하나의 공인 IP 주소를 여러 사설 IP 주소가 공유할 수 있도록 하는 NAT의 일종

### 포트 포워딩
- 포트 포워딩 : 네트워크 내 특정 호스트에 IP 주소와 포트 번호를 미리 할당하고, 해당 IP 주소:포트 번호로써 해당 호스트에게 패킷을 전달하는 기능

### ICMP : IP의 신뢰할 수 없는 특성과 비연결형 전송 특성을 보완하기 위한 네트워크 계층의 포로토콜
- IP 패킷의 전송 과정에 대한 피드백 메시지를 얻기 위해 사용하는 프로토콜

- ICMP 메시지(피드백 메시지)의 종류
  - 전송 과정에서 발생한 문제 상황에 대한 오류 보고
  - 네트워크에 대한 진단 정보


## TCP와 UDP
- 전송 계층에서 가장 중요한 프로토콜 : TCP, UDP
  - TCP : 신뢰할 수 있는 통신을 위한 연결형 프로토콜
  - UDP : 신뢰성은 떨어지지만 비교적 빠른 통신이 가능한 비연결형 프로토콜 

### TCP 통신 단계와 세그먼트 구조
- 크게 세 단계로 나누면
  - 연결 수립
  - 데이터 송수신 > 4-3에서 학습 예정
  - 연결 종료
- MSS 
  - Maximum Segment Size의 약자
  - TCP로 전송할 수 있는 최대 페이로드 크기
  - TCP 헤더 크기는 제외

- TCP 세그먼트 헤더 구조
  - 송신지 포트와 수신지 포트 : 송신지 or 수신지 애플리케이션을 식별하는 포트 번호가 명시되는 필드
  
  - 순서 번호 : 순서 번호가 명시되는 필드
    - 순서 번호란 송수신 되는 세그먼트의 올바른 순서를 보장하기 위해 세그먼트 데이터의 첫 바이트에 부여되는 번호
  
  - 확인 응답 번호 : 상대 호스트가 보낸 세그먼트에 대한 응답, 다음으로 수신하기를 기대하는 순서 번호가 명시

  - 제어 비트 : 플래그 비트라고도 부름, 현제 세그먼트에 대한 부가 정보를 나타냄
  - 윈도우 : 수신 윈도우의 크기가 명시
    - 수신 윈도우 : 한 번에 수신하고자 하는 데이터의 양

### 제어 비트
- 8비트로 구성
- 자주 언급 되는 세 개의 제어 비트
  - ACK : 세그먼트의 승인을 나타내기 위한 비트
  - SYN : 연결을 수립하기 위한 비트
  - FIN : 연결을 종료하기 위한 비트

### 순서 번호와 확인 응답 번호
- TCP의 신뢰성을 보장하기 위해 사용되는 중요한 필드로, 한쌍으로 묶어서 기억하도록 하자

- 순서 번호
  - 처음 통신을 위해 연결을 수립한 경우, 즉 제어 비트에서 연결을 수립하기 위한 비트인 SYN 플래그가 1로 설정된 세그먼트의 경우 순서 번호는 무작위 값이 됨
  - 이를 초기 순서 번호라고 함
  - 연결 수립 이후 데이터를 송신하는 동안 순서 번호는 송신한 바이트를 더해 가능 형태로 누적값을 가짐
  - 즉, 순서 번호는 초기 순서 번호 + 송신한 바이트 수가 되는 셈

- 확인 응답 번호
  - 순서 번호에 대한 응답
    - 일반적으로 수신한 순서 번호 + 1
    

### TCP 연결 수립과 종료
- 연결 수립 : 쓰리 웨이 핸드셰이크
  - 쓰리 웨이 핸드셰이크 : 세 개의 단계로 이루어 진 TCP의 연결 수립 과정을 의미
  - 엑티브 오픈 : 처음 연결을 시작하는 호스트의 연결 수립 과정
  - 패시브 오픈 : 연결 요청을 받고정
- 연결 종료
  - 액티브 클로즈 : 먼저 연결을 종료하려는 호스트에 의해 수행됨
  - 패시브 클로즈 : 연결 종료 요청을 받아들이는 호스트에 의해 수행

### TCP 상태
- 상태 : 현재 어떤 통신과정에 있는지 나타내는 정보
- TCP는 상태를 유지하고 활용한다는 점에서 스테이트풀 프로토콜이라고도 부름
- 상태의 종류
  - 연결이 수립되지 않은 상태
    - CLOSED, LISTEN
      - CLOSED : 아무런 연결이 없는 상태 
      - LISTEN : 일종의 연결 대기 상태
      
  - 연결 수립 과정에서 주로 볼 수 있는 상태
    - SYN-SENT, SYN-RECEIVED, ESTABLISHED
      - SYN-SENT : 액티브 오픈 호스트가 SYN 세그먼트를 보낸 뒤 그에 대한 응답인 SYN+ACK 세그먼트를 기다리는 상태
      - SYN-RECEIVED : 패시브 오픈 호스트가 SYN+ACK 세그먼트를 보낸 뒤 그에 대한 ACK 세그먼트를 기다리는 상태
      - ESTABLISHED : 연결이 확립되었음을 나타내는 상태
    
  - 연결 종료 과정에서 주로 볼 수 있는 상태
    - FIN-WAIT-1, CLOSED-WAIT, FIN-WAIT-2, LAST-ACK, TIME-WAIT, CLOSING
      - FIN-WAIT-1 : 일반적인 TCP 연결 종료 과정에 있어 FIN-WAIT-1은 연결 종료의 첫 단계
      - CLOSED-WAIT : 종료 요청중인 FIN 세그먼트를 받은 패시브 클로즈 호스트가 그에 대한 응답으로 ACK 세그먼트를 보낸 뒤 대기하는 상태 
      - FIN-WAIT-2 : FIN-WAIT-1 상태에서 ACK 세그먼트를 받게되면 FIN-WAIT-2 상태가 됩
      - LAST-ACK : CLOSED-WAIT 상태에서 FIN 세그먼트를 전송한 뒤 이에 대한 ACK 세그먼트를 기다리는 상태
      - TIME-WAIT : 액티브 클로즈 호스트가 FIN 세그먼트를 수신한 뒤, 이에 대한 ACK 세그먼트를 전송한 뒤 접어드는 상태
      - CLOSING : 보통 동시에 연결을 종료하려 할 때 전이되는 상태


### UDP 데이터그램 구조
- UDP는 상태를 유지하지 않고, 활용도 하지 않음 > 스테이트리스 프로토콜의 일종

- UDP 데이터그램의 구조
  - 송신지 포트 : 송신지 포트 번호
  - 수신지 포트 : 수신지 포트 번호
  - 길이 : 헤더를 포함한 UDP 데이터그램의 바이트가 담김
  - 체크섬 : 데이터그램 전송 과정에서 오류가 발생했는지 검사하기 위한 필드



### TCP의 오류-흐름-혼잡 제어
- TCP는 재전송 기반으로 다양한 오류를 제어, 흐름제어를 통해 처리할 수 있을 만큼의 데이터만 주고 받음
- 혼잡 제어를 통해 네트워크가 혼잡한 정도에 따라 전송량 조절


### 오류 제어: 재전송 기법
- 메시지를 전송한 뒤 그에 대한 답변을 받는 데까지 걸리는 시간 (RTT : Round Trip Time)
- 오류 검출과 재전송
  - 중복된 ACK 세그먼트를 수선했을 때
  - 타임아웃이 발생했을 때
    - TCP 세그먼트를 송신하는 호스트는 모두 재전송 타이머라는 값을 유지
      - 타임아웃 : 재전송 타이머의 카운트다운이 끝난 상황
      - 타임아웃이 발생하기 전까지 ACK 세그먼트를 받지 못하면 세그먼트 재전송

- ARQ: 재전송 기법
  - ARQ : 수신 호스트의 답변(ACk)과 타임아웃 발생을 토대로 문제를 진단, 문제가 생긴 메시지를 재전송함으로써 신뢰성을 확보하는 방식
    - 종류
      - Stop-and-Wait ARQ
        - 제대로 전달헀음을 확인하기 전까지는 새로운 메시지를 보내지 않는 방식
      - Go-Back-NARQ
        - 파이프라이닝 : 연속해서 메시지를 전송할 수 있는 기술
        - 파이프라이닝 방식을 활용해 여러 세그먼트를 전송하고, 도중에 잘못 전송된 세그먼트가 발생 시 해당 세그먼트부터 전부 재전송
        - 이러한 방식으로 ACK 세그먼트를 n번까지의 확인 응답으로 보고 Go-Back-NARQ의 ACK 세그먼트를 누적 확인 응답이라고 함
      - Selective Repeat ARQ
        - 선택적으로 재전송하는 방법
        - Go-Back_N ARQ의 ACK가 누적 확인 응답이라면 Selective Repeat ARQ의 ACK 세그먼트는 개별 확인 응답
      

### 흐름 제어 : 슬라이딩 윈도우
- 수신 버퍼 : 수신된 세그먼트가 애플리케이션 프로세스에 의해 읽히기 전에 임시로 저장되는 공간
- 송신 호스트가 흐름 제어를 고려하지 않고 수신 버퍼의 크기보다 많은 데이터를 전송하면 일부 세그먼트가 처리되지 못할 수 있음
  - 이렇게 버퍼가 넘치는 문제 상황을 버퍼 오버플로우라고 함

- 오늘날 TCP의 흐름 제어로 슬라이딩 윈도우를 사용
- 윈도우 : 송신 호스트가 파이프라이닝할 수 있는 최대량


### 혼잡 제어
- 혼잡 : 많은 트래픽으로 인해 패킷의 처리 속도가 늦어지거나 유실될 우려가 있는 네트워크 상황
- 혼잡 제어 : 혼잡을 제어하기 위한 기능
  - 흐름제어의 주체가 수신 호스트라면 혼잡 제어의 주체는 송신 호스트임
    - 송신 호스트는 네트워크 혼잡도를 판단하고 혼잡한 정도에 맞춰 유동적으로 전송량을 조절하며 전송
- 혼잡 윈도우 : 혼잡 없이 전송할 수 있을 법한 데이터양
  - 혼잡 윈도우의 크기를 결정하기 위해 혼잡 제어 알고리즘 사용
    - AIMD : Additive Increase/Multiplicative Decrease의 약자 > 합으로 증가, 곱으로 감소
      - 혼잡이 감지되지 않으면 혼잡 윈도우를 1씩 선형적으로 증가, 감지되면 반으로 줄임
      
    - 느린 시작 알고리즘 
      - 혼잡 윈도우를 1부터 시작 문제 없이 수신된 ACK 세그먼트 하나당 1씩 증가 > RTT마다 2배씩 지수적으로 증가
      - 느린 시작 임계치 : 느린 시작 알고리즘 시작 시 정해져 있음
        - 타임아웃 발생 : 혼잡 윈도우를 1로, 느린 시작 임계치를 혼잡이 감지 되었을 시점의 혼잡 윈도우 값의 절반으로 초기화 후 재시작
        
        - 혼잡 윈도우 >= 느린 시작 임계치 : 느린 시작 종료, 혼잡 윈도우 절반으로 초기화한 뒤 혼잡 회피 수행
        
        - 세 번의 중복 ACK 발생 : 빠른 회복 수행

    - 혼잡 회피 알고리즘
      - 혼잡 회피 알고리즘 : RTT마다 혼잡 윈도우를 1MSS씩 증가시키는 알고리즘
        - 타임아웃 발생시 혼잡 윈도우 1로, 느린 시작 임계치는 혼잡이 감지된 시점의 혼잡 윈도우 값의 절반으로 초기화후 느린 시작을 수행
        - 세번의 중복 ACK 세그먼트 발생시 혼잡 윈도우 값, 느린 시작 임계치를 절반 떨어뜨리고 빠른 회복 알고리즘 시작
        
    - 빠른 회복 알고리즘
      - 세번의 중복된 ACK 세그먼트를 수신하면 빠른 재전송과 더불어 빠른 회복 알고리즘 수행
        - 빠른 회복 : 느린 시작을 건너뛰고 혼잡 회피를 수행하는 알고리즘
          - 빠른 회복중 타임 아웃 발생 시 : 혼잡 윈도우 크기 1, 느린 시작 임계치는 혼잡 감지 시점의 절반 > 다시 느린 시작을 수행
          
- ECN: 명시적 혼잡 알림
  - 명시적 혼잡 알림 : 혼잡을 회피하기 위해 네트워크 중간 장치(주로 라우터)의 도움을 받는 방법
  - 




